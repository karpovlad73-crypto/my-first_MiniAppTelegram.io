<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>–°–∞–ø—ë—Ä ‚Äî Telegram Mini App</title>

<style>
:root {
  --bg:#0b0e14;
  --cell:#1c2230;
  --open:#2a3245;
  --accent:#3b82f6;
  --text:#e5e7eb;
  --danger:#ef4444;
}

*{box-sizing:border-box;-webkit-tap-highlight-color:transparent}

body{
  margin:0;
  background:var(--bg);
  font-family:system-ui,sans-serif;
  color:var(--text);
  display:flex;
  justify-content:center;
  min-height:100vh;
}

.app{
  width:100%;
  max-width:420px;
  padding:14px;
}

.top{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:10px;
}

.grid{
  display:grid;
  gap:8px;
}

.cell{
  aspect-ratio:1;
  background:var(--cell);
  border-radius:12px;
  display:flex;
  justify-content:center;
  align-items:center;
  font-size:18px;
  font-weight:600;
  transition:.15s;
}

.cell:active{transform:scale(.95)}
.cell.open{background:var(--open)}
.cell.mine{background:var(--danger)}
.cell.flag{font-size:20px}

button,select{
  background:var(--accent);
  color:#fff;
  border:none;
  padding:6px 10px;
  border-radius:10px;
}
</style>
</head>

<body>
<div class="app">
  <div class="top">
    <div>üö© <span id="flags">0</span> | ‚è± <span id="time">0</span>—Å</div>
    <div>
      <select id="level">
        <option value="6">–õ—ë–≥–∫–∏–π</option>
        <option value="8">–°—Ä–µ–¥–Ω–∏–π</option>
        <option value="10">–°–ª–æ–∂–Ω—ã–π</option>
      </select>
      <button onclick="restart()">‚Üª</button>
    </div>
  </div>
  <div id="grid" class="grid"></div>
</div>

<script>
/* ---------- TELEGRAM SAFE ---------- */
const TG = window.Telegram && Telegram.WebApp ? Telegram.WebApp : null;
TG?.ready();
TG?.expand();

function haptic(type){
  if(!TG) return;
  if(type==='success' || type==='error')
    TG.HapticFeedback.notificationOccurred(type);
  else
    TG.HapticFeedback.impactOccurred(type);
}

/* ---------- GAME ---------- */
let SIZE=6, MINES=6;
let field, opened, flagged;
let started=false, over=false;
let flags=0, time=0, timer;

const grid=document.getElementById('grid');
const flagsEl=document.getElementById('flags');
const timeEl=document.getElementById('time');
const levelEl=document.getElementById('level');

levelEl.onchange=()=>{
  SIZE=+levelEl.value;
  MINES=SIZE===6?6:SIZE===8?12:20;
  restart();
};

function restart(){
  clearInterval(timer);
  started=false; over=false;
  flags=0; time=0;
  flagsEl.textContent=0;
  timeEl.textContent=0;

  field=Array(SIZE*SIZE).fill(0);
  opened=Array(SIZE*SIZE).fill(false);
  flagged=Array(SIZE*SIZE).fill(false);

  grid.style.gridTemplateColumns=`repeat(${SIZE},1fr)`;
  placeMines(); numbers(); render();
}

function placeMines(){
  let m=0;
  while(m<MINES){
    let i=Math.random()*field.length|0;
    if(field[i]!=='M'){field[i]='M';m++;}
  }
}

function numbers(){
  for(let i=0;i<field.length;i++){
    if(field[i]==='M')continue;
    field[i]=neighbors(i).filter(n=>field[n]==='M').length;
  }
}

function neighbors(i){
  let x=i%SIZE,y=i/SIZE|0,r=[];
  for(let dx=-1;dx<=1;dx++)
    for(let dy=-1;dy<=1;dy++){
      if(!dx&&!dy)continue;
      let nx=x+dx,ny=y+dy;
      if(nx>=0&&ny>=0&&nx<SIZE&&ny<SIZE)
        r.push(ny*SIZE+nx);
    }
  return r;
}

function startTimer(){
  timer=setInterval(()=>timeEl.textContent=++time,1000);
}

function openCell(i){
  if(over||opened[i]||flagged[i])return;
  if(!started){started=true;startTimer();}
  opened[i]=true;
  haptic('light');

  if(field[i]==='M'){lose();return;}
  if(field[i]===0)neighbors(i).forEach(openCell);
  checkWin(); render();
}

function toggleFlag(i){
  if(opened[i]||over)return;
  flagged[i]=!flagged[i];
  flags+=flagged[i]?1:-1;
  flagsEl.textContent=flags;
  haptic('medium');
  checkWin(); render();
}

function lose(){
  over=true; clearInterval(timer);
  haptic('error');
  field.forEach((v,i)=>v==='M'&&(opened[i]=true));
  render(); setTimeout(()=>alert('üí• –ü—Ä–æ–∏–≥—Ä—ã—à'),100);
}

function checkWin(){
  let safe=0;
  for(let i=0;i<field.length;i++)
    if(field[i]!=='M'&&opened[i])safe++;
  if(safe===field.length-MINES){
    over=true; clearInterval(timer);
    haptic('success');
    setTimeout(()=>alert('üéâ –ü–æ–±–µ–¥–∞!'),100);
  }
}

function render(){
  grid.innerHTML='';
  field.forEach((v,i)=>{
    let c=document.createElement('div');
    c.className='cell';
    if(opened[i]){
      c.classList.add('open');
      if(v==='M'){c.textContent='üí£';c.classList.add('mine')}
      else if(v>0)c.textContent=v;
    }
    if(flagged[i]){c.textContent='üö©';c.classList.add('flag')}

    let t;
    c.ontouchstart=()=>t=setTimeout(()=>toggleFlag(i),400);
    c.ontouchend=()=>clearTimeout(t);
    c.onclick=()=>openCell(i);

    grid.appendChild(c);
  });
}

restart();
</script>
</body>
</html>
